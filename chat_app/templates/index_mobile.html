<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>VobaChat</title>
        <style>
                * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                }

                body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 10px;
                }

                .chat-container {
                        background: rgba(45, 55, 72, 0.95);
                        backdrop-filter: blur(15px);
                        border-radius: 25px;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        border: 1px solid rgba(255, 193, 7, 0.2);
                        width: 100%;
                        max-width: 400px;
                        height: 85vh;
                        display: flex;
                        flex-direction: column;
                        overflow: hidden;
                }

                .chat-header {
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        color: #1a202c;
                        padding: 15px 20px;
                        position: relative;
                        border-radius: 25px 25px 0 0;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        align-items: center;
                }

                .header-title {
                        font-size: 1.4rem;
                        font-weight: 600;
                        margin: 0;
                }

               .settings-button {
                       font-size: 1.3rem;
                       text-decoration: none;
               }

                .chat-messages {
                        flex: 1;
                        overflow-y: auto;
                        padding: 15px;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        background: #2d3748;
                }

                .message {
                        max-width: 85%;
                        padding: 12px 16px;
                        border-radius: 20px;
                        word-wrap: break-word;
                        animation: slideIn 0.3s ease-out;
                        font-size: 0.95rem;
                        line-height: 1.4;
                }

                @keyframes slideIn {
                        from {
                                opacity: 0;
                                transform: translateY(10px);
                        }
                        to {
                                opacity: 1;
                                transform: translateY(0);
                        }
                }

                .user-message {
                        align-self: flex-end;
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        color: #1a202c;
                        margin-left: auto;
                        font-weight: 500;
                        border-radius: 5px;
                        padding: 5px 5px;
                }

                .bot-message {
                        align-self: flex-start;
                        background: rgba(74, 85, 104, 0.8);
                        color: #e2e8f0;
                        border: 2px solid rgba(255, 193, 7, 0.3);
                        border-radius: 5px;
                        padding: 5px 5px;
                }

                .typing-indicator {
                        display: none;
                        align-self: flex-start;
                        background: rgba(74, 85, 104, 0.6);
                        border: 1px solid rgba(255, 193, 7, 0.3);
                        padding: 12px 16px;
                        border-radius: 20px;
                        margin-bottom: 12px;
                }

                .typing-dots {
                        display: flex;
                        gap: 4px;
                }

                .typing-dot {
                        width: 6px;
                        height: 6px;
                        border-radius: 50%;
                        background: #fbbf24;
                        animation: typing 1.4s infinite ease-in-out;
                }

                .typing-dot:nth-child(1) { animation-delay: -0.32s; }
                .typing-dot:nth-child(2) { animation-delay: -0.16s; }

                @keyframes typing {
                        0%, 80%, 100% { transform: scale(0); }
                        40% { transform: scale(1); }
                }

                @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                }

                .chat-input-container {
                        padding: 15px;
                        background: rgba(45, 55, 72, 0.95);
                        border-top: 1px solid rgba(255, 193, 7, 0.3);
                        border-radius: 0 0 25px 25px;
                }

                .input-group {
                        display: flex;
                        gap: 8px;
                        align-items: flex-end;
                }

                .chat-input {
                        flex: 1;
                        padding: 12px 16px;
                        border: 2px solid rgba(255, 193, 7, 0.4);
                        border-radius: 20px;
                        font-size: 0.95rem;
                        resize: none;
                        min-height: 44px;
                        max-height: 100px;
                        font-family: inherit;
                        transition: all 0.3s ease;
                        background: rgba(74, 85, 104, 0.8);
                        color: #e2e8f0;
                }

                .chat-input::placeholder {
                        color: #a0aec0;
                }

                .chat-input:focus {
                        outline: none;
                        border-color: #f59e0b;
                        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
                        background: rgba(74, 85, 104, 0.95);
                }

                .chat-input.dragover {
                        border-color: #f59e0b;
                        background: rgba(74, 85, 104, 0.9);
                }

                .send-button {
                        padding: 12px 18px;
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        color: #1a202c;
                        border: none;
                        border-radius: 20px;
                        font-size: 0.95rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        min-width: 70px;
                        justify-content: center;
                }

                .send-button:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
                }

                .send-button:disabled {
                        opacity: 0.6;
                        cursor: not-allowed;
                        transform: none;
                }
          
                .error-message {
                        background: rgba(220, 38, 38, 0.2);
                        color: #fca5a5;
                        border: 1px solid rgba(220, 38, 38, 0.4);
                        padding: 12px 16px;
                        border-radius: 20px;
                        align-self: flex-start;
                }

                /* Scrollbar styling */
                .chat-messages::-webkit-scrollbar {
                        width: 4px;
                }

                .chat-messages::-webkit-scrollbar-track {
                        background: rgba(74, 85, 104, 0.3);
                        border-radius: 8px;
                }

                .chat-messages::-webkit-scrollbar-thumb {
                        background: rgba(255, 193, 7, 0.6);
                        border-radius: 8px;
                }

                .chat-messages::-webkit-scrollbar-thumb:hover {
                        background: rgba(255, 193, 7, 0.8);
                }
                
        </style>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

</head>
<body>
        <div class="chat-container">

               <div class="chat-header">
                       <h1 class="header-title">VobaChat</h1>
                       <a href="/settings" class="settings-button" aria-label="Settings">⚙️</a>
               </div>

                <div class="chat-input-container">
                        <div class="input-group">
                                <button class="send-button" id="scanButton">Scan</button>
                        </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                        <div class="bot-message">
                                Hello! I'm VobaChat, your AI assistant. How can I help you today?
                        </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                        <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                        </div>
                </div>
                
                <div class="chat-input-container">
                        <div class="input-group">
                                <textarea 
                                        class="chat-input" 
                                        id="messageInput" 
                                        placeholder="Type your message here..." 
                                        rows="1"
                                ></textarea>
                                <button class="send-button" id="sendButton">
                                        Send
                                </button>
                        </div>
                </div>
        </div>

        <script>
                const chatMessages = document.getElementById('chatMessages');
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');
                const typingIndicator = document.getElementById('typingIndicator');
               const scanButton = document.getElementById('scanButton');

                // Auto-resize textarea
                messageInput.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });

                // Send message on Enter (but allow Shift+Enter for new lines)
                messageInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                sendMessage();
                        }
                });


                sendButton.addEventListener('click', sendMessage);
                scanButton.addEventListener('click', scanFolder);

                function normalizeMessagePayload(data) {
                        // Back-compat with old `{ response: "..." }`
                        if (data?.message && typeof data.message.content === 'string') return data.message;
                        if (typeof data?.response === 'string') return { format: 'text', content: data.response };
                        return { format: 'text', content: String(data ?? '') };
                }

                function renderContentInto(el, payload) {
                        const { format, content } = payload || {};
                        if (format === 'markdown') {
                                const html = DOMPurify.sanitize(marked.parse(content || ''));
                                el.innerHTML = html;
                        } else {
                                el.textContent = content || '';
                                el.style.whiteSpace = 'pre-wrap'; // keep \n in plaintext
                        }
                }

                function addMessage(payloadOrString, isUser = false, isError = false) {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = isError
                                ? 'error-message'
                                : (isUser ? 'user-message' : 'bot-message');

                        // Keep user/error as plain text for safety
                        if (isUser || isError) {
                                const text = typeof payloadOrString === 'string'
                                        ? payloadOrString
                                        : (payloadOrString?.content ?? String(payloadOrString ?? ''));
                                messageDiv.textContent = text;
                                messageDiv.style.whiteSpace = 'pre-wrap';
                        } else {
                                const payload = (typeof payloadOrString === 'string')
                                        ? { format: 'text', content: payloadOrString }
                                        : payloadOrString;
                                renderContentInto(messageDiv, payload);
                        }

                        chatMessages.appendChild(messageDiv);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                function showTypingIndicator() {
                        typingIndicator.style.display = 'block';
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                function hideTypingIndicator() {
                        typingIndicator.style.display = 'none';
                }

                function scanFolder() {
                        scanButton.disabled = true;
                        fetch('/ingest', {
                                method: 'POST',
                                headers: {
                                        'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({})
                        })
                        .then(response => response.json())
                        .then(data => {
                                hideTypingIndicator();
                                if (data.error) {
                                        addMessage(data.error, false, true);
                                        return;
                                }
                                const payload = normalizeMessagePayload(data);
                                addMessage(payload, false);
                                scanButton.textContent = 'Rescan';
                        })

                        .catch(error => {
                                console.error('Error:', error);
                                addMessage('Error scanning folder.', false, true);
                        })
                        .finally(() => {
                                scanButton.disabled = false;
                        });
                }

                function sendMessage() {
                        const message = messageInput.value.trim();
                        if (!message) return;

                        // Add user message to chat
                        addMessage(message, true);
                        
                        // Clear input and reset height
                        messageInput.value = '';
                        messageInput.style.height = 'auto';
                        
                        // Disable send button and show typing indicator
                        sendButton.disabled = true;
                        showTypingIndicator();

                       const endpoint = '/chat';

                       fetch(endpoint, {
                                method: 'POST',
                                headers: {
                                        'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ message: message })
                        })
                        .then(response => response.json())
                        .then(data => {
                                hideTypingIndicator();
                                if (data.error) {
                                        addMessage(data.error, false, true);
                                        return;
                                }
                                const payload = normalizeMessagePayload(data);
                                addMessage(payload, false);
                        })

                        .catch(error => {
                                hideTypingIndicator();
                                console.error('Error:', error);
                                addMessage('Sorry, there was an error connecting to the server. Please try again.', false, true);
                        })
                        .finally(() => {
                                sendButton.disabled = false;
                                messageInput.focus();
                        });
                }

                // Focus input on page load
                window.addEventListener('load', () => {
                        messageInput.focus();
                });
        </script>
        <!-- MOBILE VERSION -->

</body>
</html>